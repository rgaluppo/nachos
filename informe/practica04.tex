\chapter{Resolución de la Práctica N\grad4: Memoria virtual y TLB}
\section{Implementar TLB} \label{update_TLB}
Capturamos las excepciones \texttt{PageFaultException} y \texttt{ReadOnlyException}.\\
Cuando ocurre la primera, se obtiene la dirección de memoria que la originó leyendo el valor del registro \texttt{R39}. Luego se invoca a \texttt{AddrSpace::UpdateTLB} para que cree una nueva entrada en la tabla para dicho valor. Notemos que al retornar no se realiza un aumento en el \texttt{PC}. Por lo tanto, se ejecutara nuevamente la sentencia que origino la excepción.
\begin{lstlisting}[style=C]
if (which == SyscallException) {
	...
} else {
	DEBUG('e', "Is not a SyscallException\n");
    const char *exception = "";
    switch(which) {
    	...
    	
		case PageFaultException:
		{
	    	int failVirtAddr = machine -> ReadRegister(BadVAddrReg);

	        DEBUG('v',"\n Antes de actualizar la TLB: failVAddr=%d \n", failVirtAddr);
			currentThread->space->UpdateTLB(failVirtAddr / PageSize);
	        return;
		}
	    case ReadOnlyException: 
	    	exception = "ReadOnlyException";
    	    break;	    
    	...
    	
    	default:
                printf("Unexpected user mode exception.");
                ASSERT(false);
    }
    printf("Unexpected user mode exception:\t which=%s  type=%d\n", exception, type);
    ASSERT(false);
}
\end{lstlisting}
Como mencionamos anteriormente, se agrega el método \texttt{AddrSpace::UpdateTLB}
\begin{lstlisting}[style=C]
void UpdateTLB(int position);   // update TLB table;
\end{lstlisting}
Se utiliza para cuando la página a utilizar no se encuentra en el \textbf{TLB}. Se encarga de buscarla en la memoria y guardarla en la \textbf{TLB}.
\section{Análisis de TLB cambiando la cantidad de entradas}
\subsection*{Modificaciones}
Para ver como influye el tamaño de la \textbf{TLB} respecto a la cantidad de paginas que fallan, se agregaron dos indicadores a las estadísticas de \textbf{NachOS}. Ellos se encuentran en \texttt{stats.h}.
\begin{lstlisting}[style=C]
int numPageFaults;  // number of virtual memory page faults
int numPagesFound;  // number of virtual memory page founds
\end{lstlisting}
El primero se incrementa cuando ocurre un fallo de paginación. Esto ocurre cuando se captura la excepción \texttt{PageFaultException}. En cambio, el segundo se incrementa cuando se encuentra la pagina. Ocurre al final del constructor \texttt{Translate::Translate}.\\
Para modificar el tamaño de la TLB, se modifica la variable \texttt{TLBSize}, declarada en \texttt{system.h}.
\subsection*{Resultados}
Se realizaron distintas pruebas variando la cantidad de entradas de la tabla. Los valores de prueba fueron 4, 16, 32, 64, 128 y 256. Ademas, la pagina que sale es elegida al azar.\\
En \ref{tab:practica04:statics} se muestra los porcentajes de aciertos y fallas de la \textbf{TLB}, para los programas \texttt{matmult.c} y \texttt{sort.c}.\\ 
\begin{table}
	\center
	\begin{tabular}{|c|c|c|}
	    \hline
		\multirow{2}{*}{TLB size}   &    \multicolumn{2}{c|}{Programa}           \\
		\cline{2-3}
                                    &    \texttt{mathmult}    &    \texttt{sort} \\
		\hline
		\multirow{2}{*}{4}          &     faults:  7,60\%     &    faults:  4,36\% \\
		                            &     hits  : 92,39\%     &    hits  : 95,64\%    \\               
		\multirow{2}{*}{16}         &     faults:  0,569\%    &    faults:  0,042\%    \\
		                            &     hits  : 99,43\%     &    hits  : 99,958\%    \\             
		\multirow{2}{*}{32}         &     faults:  0,013\%    &    faults:  0,035\%    \\
		                            &     hits  : 99,986\%    &    hits  : 99,996\%    \\               
		\multirow{2}{*}{64}         &     faults:  0,006\%    &    faults:  0,0001\%    \\
		                            &     hits  : 99,993\%    &    hits  : 99,999\%    \\               
		\multirow{2}{*}{128}        &     faults:  0,006\%    &    faults:  0,0001\%    \\
		                            &     hits  : 99,993\%    &    hits  : 99,999\%    \\               
		\multirow{2}{*}{256}        &     faults:  0,006\%    &    faults:  0,0002\%    \\
		                            &     hits  : 99,994\%    &    hits  : 99,999\%    \\ \hline             
	\end{tabular}
    \caption{Estadísticas para los programas \texttt{mathmult} y \texttt{sort}, variando el tamaño de la TLB.}
	\label{tab:practica04:statics}
\end{table}
Para ésta forma de seleccionar la página  que sale de la \textbf{TLB}, encontramos una cota máxima de rendimiento en una tabla con 64 entradas. Notamos que una tabla con mas entradas, se sigue teniendo el mismo rendimiento.
\newpage
\section{Implementar carga por demanda}
Cuando se inicia un programa, no va a tener ninguna de sus páginas en memoria. Ellas, se cargarán cuando el sistema solicite acceder a alguna de ellas.\\
Para implementar esto, cuando se crea el espacio de direcciones de un thread se le asigna \texttt{-{}1} a la dirección física de cada una de sus páginas y a su vez se setea el bit de \texttt{valid} en \texttt{false}. Con esto último se indica que la página no está en memoria. Por lo tanto, las páginas se irán cargando en memoria conforme se reciban las \texttt{PageFaultException}.\\
Se agregaron los siguientes métodos a la clase \texttt{AddrSpace}:
\begin{lstlisting}[style=C]
  public:
    ...
    void OnDemandLoad(TranslationEntry *page, int errorAddr); // Load page on memory by demand.
    void LoadPage(TranslationEntry *page); // Load a page into memory.
  private:
    OpenFile *executable_file; // Save executeble for load later.
    NoffHeader noff_hdr; // Save header for load later
\end{lstlisting}
Se modificó el método \texttt{AddrSpace::UpdateTLB} para que llame a \texttt{AddrSpace::OnDemandLoad}, cuya función es chequear el estado de la página. Si ya tiene asignada una dirección física, se continúa con la actualización del \textbf{TLB} como se explicó en \nameref{update_TLB}. En caso contrario, se llama al método \texttt{AddrSpace::LoadPage}, el cual le asigna a la página una posición en el mapa de bits y la carga en memoria. Finalmente, continua la ejecución de \texttt{AddrSpace::UpdateTLB} para actualizar el \textbf{TLB}.
\section{Implementar la política de paginación FIFO}
\section{Mejorar la política de paginación}